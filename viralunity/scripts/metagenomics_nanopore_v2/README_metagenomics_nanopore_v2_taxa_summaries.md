# Metagenomics Nanopore v2 — Taxonomic Summaries

This document describes the **standardized taxonomic summary outputs** generated by the
`metagenomics_nanopore_v2` workflow in ViralUnity.

These summaries provide a unified and machine-readable view of taxonomic assignments
across classifiers (**Kraken2**, **DIAMOND**) and analysis modes (**reads**, **contigs**).

---

## Overview

For each enabled analysis category, ViralUnity produces:

- One **per-sample taxonomic summary**
- One **merged summary** combining all samples

Summaries are derived **exclusively from Krona input files**
(`sequence_id<TAB>taxid`) and the NCBI taxdump, ensuring consistency across tools.

---

## Generated summary files

Depending on which analyses are enabled, the following files may be created:

```
metagenomics/taxonomic_assignments/
├── kraken2_reads/
│   ├── summary/{sample}.taxa.tsv
│   └── kraken2_reads_taxa_summary.tsv
├── kraken2_contigs/
│   ├── summary/{sample}.taxa.tsv
│   └── kraken2_contigs_taxa_summary.tsv
├── diamond_reads/
│   ├── summary/{sample}.taxa.tsv
│   └── diamond_reads_taxa_summary.tsv
└── diamond_contigs/
    ├── summary/{sample}.taxa.tsv
    └── diamond_contigs_taxa_summary.tsv
```

Each directory corresponds to a **tool × mode** combination.

---

## Input data used

All summaries are computed from:

- Krona input TSV files (`seq_id<TAB>taxid`)
- NCBI taxdump (`nodes.dmp`, `names.dmp`)

This design avoids tool-specific report parsing and guarantees consistent taxonomic logic.

---

## Output schema

Each summary TSV follows the schema below:

| Column   | Description |
|---------|-------------|
| sample  | Sample identifier |
| tool    | Classifier used (`kraken2` or `diamond`) |
| mode    | Analysis mode (`reads` or `contigs`) |
| rank    | Taxonomic rank (`family`, `genus`, `species`) |
| taxid   | NCBI taxonomic identifier |
| name    | Scientific name (best-effort from taxdump) |
| count   | Number of sequences assigned |
| percent | Percentage of assigned sequences |
| source  | Path to the Krona input file used |

---

## Semantics and interpretation

### Counts
- **Reads mode**: number of reads assigned
- **Contigs mode**: number of contigs assigned
- Counts are *not* base-pair–weighted

### Percent
- Computed as:
  ```
  count / total_assigned_sequences * 100
  ```
- Percentages are **relative within each sample × tool × mode**
- Kraken2 and DIAMOND percentages should **not** be compared directly

### Taxonomic propagation
Each sequence contributes to **all ancestor ranks**:
- A species-level assignment increments:
  - species
  - genus
  - family

---

## Empty and edge cases

The pipeline is robust to missing signal:

- Empty Krona inputs generate **valid TSV files with headers only**
- Merged summaries still contain headers even if all samples are empty
- No rule fails due to absence of classified sequences

This behavior ensures downstream steps never crash unexpectedly.

---

## Example rows

```
sample	tool	mode	rank	taxid	name	count	percent	source
sampleA	kraken2	reads	family	10239	Viridae	120	45.2830	.../sampleA.output.krona.txt
sampleA	kraken2	reads	genus	11292	Betacoronavirus	80	30.1887	...
sampleA	kraken2	reads	species	2697049	SARS-CoV-2	80	30.1887	...
```

---

## Intended downstream usage

These summaries are designed to support:

- Filtering by rank, taxon, or abundance
- Conversion to sample × taxon matrices
- Visualization (stacked bars, heatmaps)
- Manual inspection and reporting

They represent the **canonical taxonomic output** of the metagenomics pipeline.

---
